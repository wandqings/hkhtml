<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>视频监控控制</title>
  <style>
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: Arial, sans-serif;
      overflow: hidden;
    }

    .hkdomvideocontainer {
      width: 100%;
      height: 100%;
      /* display: flex;
      position: relative; */
      background: #000;
    }

    .hkdomvideo {
      width: 100%;
      height: 220px;
      position: relative;
    }

    .control-content {
      /* position: absolute;
      right: 0;
      top: 0; */
      width: 100%;
      height: 200px;
      background: rgba(0, 0, 0, 0.6);
      z-index: 999;
      box-sizing: border-box;
      padding: 10px;
      color: #fff;
    }

    .control-wrapper {
      position: relative;
      width: 190px;
      height: 190px;
      max-width: 190px;
      max-height: 190px;
      border-radius: 100%;
      margin: 20px auto;
    }

    .control-btn {
      display: flex;
      justify-content: center;
      align-items: center;
      position: absolute;
      width: 44%;
      height: 44%;
      border-radius: 5px;
      border: 1px solid #78aee4;
      box-sizing: border-box;
      transition: all 0.3s linear;
      background: rgba(0, 0, 0, 0.4);
    }

    .control-btn i {
      font-size: 30px;
      color: #78aee4;
    }

    .control-inner-btn {
      position: absolute;
      width: 60%;
      height: 60%;
      background: #fafafa;
    }

    .control-top {
      top: -6%;
      left: 27%;
      transform: rotate(-45deg);
    }

    .control-left {
      top: 27%;
      left: -6%;
      transform: rotate(45deg);
    }

    .control-right {
      top: 27%;
      right: -6%;
      transform: rotate(45deg);
    }

    .control-bottom {
      left: 27%;
      bottom: -6%;
      transform: rotate(45deg);
    }

    .zoom-content {
      width: 100%;
      display: flex;
      justify-content: space-around;
      margin-top: 20px;
    }

    .zoom-content i {
      font-size: 30px;
      color: #78aee4;
    }

    .fa-pause-circle {
      font-size: 40px;
      color: #fff;
    }

    .control-round {
      position: absolute;
      top: 25%;
      left: 25%;
      width: 50%;
      height: 50%;
      background: #fff;
      border-radius: 100%;
    }

    .control-round-inner {
      position: absolute;
      left: 13%;
      top: 13%;
      display: flex;
      justify-content: center;
      align-items: center;
      width: 70%;
      height: 70%;
      font-size: 40px;
      color: #78aee4;
      border: 1px solid #78aee4;
      border-radius: 100%;
      transition: all 0.3s linear;
    }
  </style>
</head>
<body>
  <div class="hkdomvideocontainer">
    <div id="hkdomvideo" class="hkdomvideo"></div>

    <div class="control-content">
      <div class="control-wrapper">
        <div class="control-btn control-top" onmousedown="ptzCamera('0')" onmouseup="stopCamera('0')">
          <i class="fa fa-arrow-up"></i>
          <div class="control-inner-btn control-inner"></div>
        </div>
        <div class="control-btn control-left" onmousedown="ptzCamera('2')" onmouseup="stopCamera('2')">
          <i class="fa fa-arrow-left"></i>
          <div class="control-inner-btn control-inner"></div>
        </div>
        <div class="control-btn control-bottom" onmousedown="ptzCamera('1')" onmouseup="stopCamera('1')">
          <i class="fa fa-arrow-down"></i>
          <div class="control-inner-btn control-inner"></div>
        </div>
        <div class="control-btn control-right" onmousedown="ptzCamera('3')" onmouseup="stopCamera('3')">
          <i class="fa fa-arrow-right"></i>
          <div class="control-inner-btn control-inner"></div>
        </div>
        <div class="control-round">
          <div class="control-round-inner">
            <i class="fa fa-pause-circle"></i>
          </div>
        </div>
      </div>

      <div class="zoom-content">
        <div onmousedown="ptzCamera('8')" onmouseup="stopCamera('8')">
          <i class="fa fa-search-plus"></i>
        </div>
        <div onmousedown="ptzCamera('9')" onmouseup="stopCamera('9')">
          <i class="fa fa-search-minus"></i>
        </div>
      </div>
    </div>
  </div>

  <!-- 引入 SDK -->
  <script src="/HikOpenVideoSDK-1.0.0.min.js"></script>
  <!-- 引入 Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" />

  <script>
    let wsClient = null;
   

    // 获取 URL 参数
function getURLParams() {
  const search = window.location.search || window.location.hash.split('?')[1] || '';
  return new URLSearchParams(search);
}

const params = getURLParams();

let appAccessToken = params.get('appAccessToken') || 'default_app_token';
let userAccessToken = params.get('userAccessToken') || 'default_user_token';
let deviceSerial = params.get('deviceSerial') || 'GA5538148';

    // // 模拟获取 token
    // function getAppTokenData() {
    //   return new Promise(resolve => {
    //     // 模拟异步获取 token
    //     setTimeout(() => {
    //       resolve({ appAccessToken: 'your_app_token' });
    //     }, 300);
    //   });
    // }

    // function getuserTokenData() {
    //   return new Promise(resolve => {
    //     setTimeout(() => {
    //       resolve({ userAccessToken: 'your_user_token' });
    //     }, 300);
    //   });
    // }

    async function initWebSocketClient() {
      if (window.WebSocketClient) {
        wsClient = new window.WebSocketClient();
        try {
          const response = await wsClient.connect();
          if (response.code === 0) {
            console.log('WebSocket连接成功');

            const appkeydata = {
              bSecret: false,
              openAppkey: '1947464820169441335',
              openAppSecret: 'MIICdgIBADANBgkqhkiG9w0BAQEFAASCAmAwggJcAgEAAoGBAOak5iLuyMzfNLDliTFtsIi4iorcX0oc6rPfaaf0EFuO7schjsUepL5YJz4saJU3kXOrn2rQoFtgD/9+2kvuisne2gUs/CFndfDAieMBlBdHzR62zi6lKAerWdFKAOWlYLwulY6O/MyqxzrQOFnZAJ1vWXfvQkM4w9FsPiaANEzdAgMBAAECgYAZtkRZnJkSDcgH+G7E7d+CPmBjfpG452RazQswSAsSyepglKMf4nynI5isW7ME/37dkEJjXAKkbR8bcn7PfDZIeKme0i2C4F9wV4ghtmhFS93Hn63do/KH3DH2h8TIjTWyb+vXCo8WCoLv+F8NdSe9CZLFHuLMT4XY3IaOSFOogQJBAP/UDslU20YyG4dk5WP0mvPAYOek16OLLuz8UMVlcS0gBpnL7AR+JFMIsQwSNKBFtsuub4jLxSuvqk8mwMwrHi0CQQDmzIP06pVS3sDdvo+ka9j37YD/0IDHuJrWjH/3fczXD7x2XQxYzdOGl9ZjH5Bdnrjmz5cGG0b1GyWy8QkY88dxAkB4JuR68nu50DbVtDF4bJ2J9cSNhwIwMWJss2RMEYTCKNRwzzGeOpBc3ywn+zT0QUnFB7wih3GnPu3CFvVd7rJRAkBq6RW/H+MnzhOdJCa5zVNmFViKJ3VgDr164P5uEJIQlTOByLxtbnqrgC5JIFfpZhrUoBifNYd7BqZB67GBI3uhAkEAoyOxi4kqcyTAzmsY7K/2ZpYs8MqAeLhm0YcraiGipReVJZIAYlFSL3TSw3kMx6c+vP1Qi4jrVA+UnU63u1IBCg=='
            };
            wsClient.setSecretConfigInfo(appkeydata, (response) => {
              console.log('initWndParam回调');
            });

            // 获取 token
            const appTokenRes = await getAppTokenData();
            appAccessToken = appTokenRes.appAccessToken;
            const userTokenRes = await getuserTokenData();
            userAccessToken = userTokenRes.userAccessToken;

            // 获取视频容器大小
            const rect = document.getElementById('hkdomvideo').getBoundingClientRect();

            // 初始化窗口参数
            const data = {
              ezAccessData: '{}',
              appAccessToken: appAccessToken,
              userAccessToken: userAccessToken,
              ezvizAddr: 'https://open.ys7.com',
              authAddr: 'https://auth.ys7.com',
              openAddr: 'https://open.ys7.com'
            };

            wsClient.initWndParam(data, (response) => {
              console.log(response, '初始化回调');
              wsClient.showWnd({}, (response) => {
                console.log(response, '窗口显示回调');
              });

              wsClient.setParentWnd({ webTitle: wsClient.guid(16) }, (res) => {
                console.log(res, '设置父窗口回调');
                wsClient.setWndGeometry({
                  rect: {
                    top: rect.top,
                    left: rect.left,
                    width: rect.width,
                    height: rect.height
                  }
                }, (res) => {
                  console.log(res, '设置窗口位置回调');
                });
              });
            });

            // 监听 resize
            window.addEventListener("resize", () => {
              const rect = document.getElementById('hkdomvideo').getBoundingClientRect();
              wsClient.setWndGeometry({
                rect: {
                  top: rect.top,
                  left: rect.left,
                  width: rect.width,
                  height: rect.height
                }
              }, (response) => {
                console.log(response, '设置窗口位置回调');
              });
            });
          }
        } catch (err) {
          console.error('WebSocket连接失败:', err);
        }
      } else {
        console.error('WebSocketClient未定义，请检查SDK加载');
      }
    }

    function initResource(deviceSerial) {
      const initResourcedata = {
        resourcesData: '',
        tokensData: '',
        capacitysData: ''
      };

      // 模拟调用接口
      setTimeout(() => {
        initResourcedata.resourcesData = JSON.stringify({
          deviceSerial: deviceSerial,
          channelNo: 1
        });
        initResourcedata.tokensData = JSON.stringify({
          deviceSerial: deviceSerial,
          token: 'mocked_token'
        });
        initResourcedata.capacitysData = JSON.stringify(['ptz', 'audio']);

        wsClient.initResource(initResourcedata, (res) => {
          console.log(res, '初始化资源回调');

          setTimeout(() => {
            wsClient.startPreview(1, {
              deviceSerial: deviceSerial,
              channelNo: 1
            }, (res) => {
              console.log(res, '开启实时预览回调');
            });
          }, 1000);
        });
      }, 500);
    }

    function ptzCamera(direction) {
      const data = {
        cmdType: 'start',
        direction: Number(direction),
        channelNo: 1,
        deviceSerial: deviceSerial
      };
      setTimeout(() => {
        wsClient.ptzControl(1, data, (res) => {
          console.log(res, '控制');
        });
      }, 500);
    }

    function stopCamera(direction) {
      const data = {
        cmdType: 'stop',
        direction: Number(direction),
        channelNo: 1,
        deviceSerial: deviceSerial
      };
      setTimeout(() => {
        wsClient.ptzControl(1, data, (res) => {
          console.log(res, '控制');
        });
      }, 500);
    }

    // 页面加载
    window.onload = async () => {
      await initWebSocketClient();
      initResource(deviceSerial);
    };

    // 页面卸载
    window.onunload = () => {
      if (wsClient) {
        wsClient.hideWnd({}, (res) => {
          console.log(res, '窗口隐藏回调');
        });
        wsClient.disconnect();
        wsClient = null;
      }
    };
  </script>
</body>
</html>
